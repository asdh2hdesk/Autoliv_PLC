<?xml version="1.0" encoding="UTF-8"?>
<templates>
    <t t-name="autoline_brake_atmt.dashboard_template">
        <div class="o_plc_dashboard final-station-dashboard">
            <!-- Hidden input for scanner capture -->
            <input
                    type="text"
                    class="o_scanner_input"
                    style="position: absolute; top: -9999px; left: -9999px; opacity: 0; width: 0; height: 0;"
                    autofocus="autofocus"
                    autocomplete="off"
                    t-on-keydown="onScannerKeyDown"
            />

            <!-- Scanner Status Alert -->
            <t t-if="state.scan_result">
                <div t-att-class="state.scan_result.match_found ? 'alert alert-success' : 'alert alert-danger'"
                     style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; padding: 15px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <strong t-esc="state.scan_result.message || ''"/>
                    <t t-if="state.scan_result.cycle_number">
                        <br/>
                        <small>Cycle:
                            <t t-esc="state.scan_result.cycle_number"/>
                        </small>
                    </t>
                    <t t-if="state.scan_result.part_name">
                        <br/>
                        <small>Part:
                            <t t-esc="state.scan_result.part_name"/>
                        </small>
                    </t>
                </div>
            </t>

            <t t-if="state.loading">
                <div class="text-center p-4">
                    <p>Loading dashboard...</p>
                </div>
            </t>
            <t t-if="!state.loading">
                <div class="o_dashboard_header">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <h1 style="margin: 0;">AutoLine PLC Dashboard</h1>
                        <div class="date-filter-buttons" style="display: flex; gap: 10px;">
                            <button 
                                class="btn btn-sm" 
                                t-att-class="state.date_filter === 'today' ? 'btn-primary' : 'btn-secondary'"
                                t-on-click="() => this.onDateFilterChange('today')">
                                Today
                            </button>
                            <button 
                                class="btn btn-sm" 
                                t-att-class="state.date_filter === 'week' ? 'btn-primary' : 'btn-secondary'"
                                t-on-click="() => this.onDateFilterChange('week')">
                                This Week
                            </button>
                            <button 
                                class="btn btn-sm" 
                                t-att-class="state.date_filter === 'month' ? 'btn-primary' : 'btn-secondary'"
                                t-on-click="() => this.onDateFilterChange('month')">
                                This Month
                            </button>
                        </div>
                    </div>

                    <div class="o_chart_body">
                        <div id="workstation-status">
                            <t t-foreach="state.workstations" t-as="workstation" t-key="workstation_index">
                                <div class="workstation-status" t-att-class="workstation.connection_status">
                                    <div class="status-indicator" t-att-class="workstation.connection_status"></div>
                                    <div class="workstation-info">
                                        <strong t-esc="workstation.name"/>
                                        <small class="text-muted">
                                            <t t-if="workstation.monitoring_active and workstation.connection_status === 'connected'">
                                                <span class="monitoring-status ready" style="color: #4caf50; font-weight: bold;">✓ Ready for Cycle</span>
                                            </t>
                                            <t t-elif="workstation.monitoring_active and workstation.connection_status !== 'connected'">
                                                <span class="monitoring-status waiting" style="color: #ff9800; font-weight: bold;">⏳ Monitoring (Waiting for Connection)</span>
                                            </t>
                                            <t t-elif="!workstation.monitoring_active and workstation.is_active">
                                                <span class="monitoring-status inactive" style="color: #f44336; font-weight: bold;">⚠ Monitoring Not Started</span>
                                            </t>
                                            <t t-else="">
                                                <span class="monitoring-status disabled" style="color: #888; font-weight: bold;">○ Inactive</span>
                                            </t>
                                            | Last:
                                            <t t-esc="workstation.last_connection ? new Date(workstation.last_connection).toISOString().slice(0, 19).replace('T', ' ') : 'Never'"/>
                                            | Cycles:
                                            <t t-esc="workstation.cycle_count || 0"/>
                                        </small>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="dashboard-logo m-2">
                            <img t-attf-src="/autoline_brake_atmt/static/src/img/ASD_Logo_Main.png"
                                 alt="ASD Logo"
                                 style="max-height: 60px; max-width: 100%; object-fit: contain; border-radius:5px;"/>
                            <p style="font-size:14px; font-weight:bold;">ASD SUPPORT SYSTEM</p>
                        </div>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="o_dashboard_metrics">
                    <div class="o_metric_card o_metric_primary">
                        <div class="o_metric_content">
                            <h5>Total Cycles</h5>
                            <h2 class="o_metric_value">
                                <t t-esc="state.dashboard_data.total_cycles || 0"/>
                            </h2>
                        </div>
                    </div>
                    <div class="o_metric_card o_metric_success">
                        <div class="o_metric_content">
                            <h5>OK Cycles</h5>
                            <h2 class="o_metric_value">
                                <t t-esc="state.dashboard_data.ok_cycles || 0"/>
                            </h2>
                        </div>
                    </div>
                    <div class="o_metric_card o_metric_danger">
                        <div class="o_metric_content">
                            <h5>NOK Cycles</h5>
                            <h2 class="o_metric_value">
                                <t t-esc="state.dashboard_data.nok_cycles || 0"/>
                            </h2>
                        </div>
                    </div>
<!--                    <div class="o_metric_card o_metric_info">-->
<!--                        <div class="o_metric_content">-->
<!--                            <h5>Quality Rate</h5>-->
<!--                            <h2 class="o_metric_value">-->
<!--                                <t t-esc="(state.dashboard_data.quality_rate || 0) + '%'"/>-->
<!--                            </h2>-->
<!--                        </div>-->
<!--                    </div>-->
                    <div class="o_metric_card o_metric_warning">
                        <div class="o_metric_content">
                            <h5>QR Scanned</h5>
                            <h2 class="o_metric_value">
                                <t t-esc="state.dashboard_data.qr_scanned || 0"/>
                            </h2>
                            <small>Match Rate:
                                <t t-esc="(state.dashboard_data.match_rate || 0) + '%'"/>
                            </small>
                        </div>
                    </div>
                    <div class="o_metric_card o_metric_success">
                        <div class="o_metric_content">
                            <h5>QR Matched</h5>
                            <h2 class="o_metric_value">
                                <t t-esc="state.dashboard_data.matched_scans || 0"/>
                            </h2>
                            <small>Total Scans:
                                <t t-esc="state.dashboard_data.total_scans || 0"/>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <!--                <div class="o_dashboard_charts o_clearfix">-->
                <!--                    <div class="o_chart_container o_chart_large">-->
                <!--                        <div class="o_chart_header">-->
                <!--                            <h5>Production Trend (Last 24 Hours)</h5>-->
                <!--                        </div>-->
                <!--                        <div class="o_chart_body">-->
                <!--                            <canvas id="production-chart" width="800" height="300"></canvas>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                    <div class="o_chart_container o_chart_small">-->
                <!--                        <div class="o_chart_header">-->
                <!--                            <h5>Workstation Status</h5>-->
                <!--                        </div>-->
                <!--                       -->
                <!--                    </div>-->
                <!--                </div>-->
                <!-- Last Cycle Info for Scanner -->
                <div class="o_dashboard_last_cycle" style="margin-top: 20px;">
                    <div class="o_panel">
                        <div class="o_panel_header">
                            <h5>Last Printed Cycle (For Scanner Verification)</h5>
                        </div>
                        <div class="o_panel_body">
                            <t t-if="state.last_cycle">
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Cycle Number:</strong>
                                            <br/>
                                            <span t-esc="state.last_cycle.cycle_number || ''"/>
                                        </div>
                                        <div class="col-md-2">
                                            <strong>Part Name:</strong>
                                            <br/>
                                            <span t-esc="state.last_cycle.part_name || ''"/>
                                        </div>
                                        <div class="col-md-5">
                                            <strong>QR Code:</strong>
                                            <br/>
                                            <code t-esc="state.last_cycle.qr_code_data || ''"/>
                                        </div>
                                        <div class="col-md-2">
                                            <strong>Status:</strong>
                                            <br/>
                                            <t t-if="state.last_cycle.qr_code_scanned">
                                                <span class="badge-custom badge-ok">✓ Scanned</span>
                                            </t>
                                            <t t-else="">
                                                <span class="badge-custom badge-pending">Pending Scan</span>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </t>
                            <t t-else="">
                                <p class="text-muted text-center">No cycles created yet</p>
                            </t>
                        </div>
                    </div>
                </div>
                <!-- Recent Cycles and Scans -->
                <div class="o_dashboard_recent o_clearfix">
                    <div class="o_panel">
                        <div class="o_panel_header">
                            <h5>Recent Cycles</h5>
                        </div>
                        <div class="o_panel_body" style="overflow-x: auto;">
                            <table class="o_list_table table" style="min-width: 1200px;">
                                <thead>
                                    <tr>
                                        <th>Variant</th>
                                        <th>Barcode (QR Code)</th>
                                        <th>Date / Time</th>
                                        <th>Torque (Nm)</th>
                                        <th>Initial Position</th>
                                        <th>Final Position</th>
                                        <th>Load Cell Value</th>
                                        <th>Cycle Time (s)</th>
                                        <th>Result</th>
                                        <th>QR Printed</th>
                                        <th>QR Scanned</th>
                                        <th>QR Match</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="state.recent_cycles" t-as="cycle" t-key="cycle_index">
                                        <tr>
                                            <td>
                                                <span t-if="cycle.variant_type === 'at'" class="badge-custom badge-info">AT</span>
                                                <span t-elif="cycle.variant_type === 'mt'" class="badge-custom badge-info">MT</span>
                                                <span t-else="" class="badge-custom badge-pending">-</span>
                                            </td>
                                            <td>
                                                <div class="text-monospace" t-esc="cycle.qr_code_data || cycle.barcode || ''"/>
                                            </td>
                                            <td>
                                                <t t-if="cycle.cycle_datetime">
                                                    <t t-esc="new Date(cycle.cycle_datetime).toISOString().slice(0, 19).replace('T', ' ')"/>
                                                </t>
                                            </td>
                                            <td t-esc="cycle.torque_nm ? cycle.torque_nm.toFixed(2) : '0.00'"/>
                                            <td t-esc="cycle.initial_position ? cycle.initial_position.toFixed(2) : '0.00'"/>
                                            <td t-esc="cycle.final_position ? cycle.final_position.toFixed(2) : '0.00'"/>
                                            <td t-esc="cycle.load_cell_value ? cycle.load_cell_value.toFixed(2) : '0.00'"/>
                                            <td t-esc="cycle.cycle_time ? cycle.cycle_time.toFixed(2) : '0.00'"/>
                                            <td>
                                                <span t-att-class="cycle.result === 'ok' ? 'badge-custom badge-ok' : cycle.result === 'nok' ? 'badge-custom badge-nok' : 'badge-custom badge-pending'">
                                                    <t t-esc="(cycle.result || '').toUpperCase()"/>
                                                </span>
                                            </td>
                                            <td>
                                                <t t-if="cycle.qr_printed">
                                                    <span class="badge-custom badge-ok">✓</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="badge-custom badge-pending">✗</span>
                                                </t>
                                            </td>
                                            <td>
                                                <t t-if="cycle.qr_scanned">
                                                    <span class="badge-custom badge-ok">✓</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="badge-custom badge-pending">✗</span>
                                                </t>
                                            </td>
                                            <td>
                                                <span t-att-class="cycle.qr_match_status === 'matched' ? 'badge-custom badge-ok' : cycle.qr_match_status === 'not_matched' ? 'badge-custom badge-nok' : 'badge-custom badge-pending'">
                                                    <t t-if="cycle.qr_match_status === 'matched'">MATCHED</t>
                                                    <t t-elif="cycle.qr_match_status === 'not_matched'">NOT MATCHED</t>
                                                    <t t-else="">PENDING</t>
                                                </span>
                                            </td>
                                        </tr>
                                    </t>
                                    <t t-if="!state.recent_cycles || state.recent_cycles.length === 0">
                                        <tr>
                                            <td colspan="12" class="text-center text-muted">No cycles yet</td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="o_panel">
                    <div class="o_panel_header">
                        <h5>Recent QR Scans</h5>
                    </div>
                    <div class="o_panel_body">
                        <table class="o_list_table table">
                            <thead>
                                <tr>
                                    <th>Date / Time</th>
                                    <th>Status</th>
                                    <th>Cycle</th>
                                    <th>Part</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="state.recent_scans" t-as="scan" t-key="scan_index">
                                    <tr>
                                        <td>
                                            <t t-if="scan.scan_datetime">
                                                <t t-esc="new Date(scan.scan_datetime).toISOString().slice(0, 19).replace('T', ' ')"/>
                                            </t>
                                        </td>
                                        <td>
                                            <span t-att-class="scan.match_status === 'matched' ? 'badge-custom badge-ok' : scan.match_status === 'not_found' ? 'badge-custom badge-nok' : 'badge-custom badge-pending'">
                                                <t t-if="scan.match_status === 'matched'">✅ MATCHED</t>
                                                <t t-elif="scan.match_status === 'not_found'">❌ NOT FOUND</t>
                                                <t t-elif="scan.match_status === 'duplicate'">⚠️ DUPLICATE</t>
                                                <t t-else="">PENDING</t>
                                            </span>
                                        </td>
                                        <td t-esc="scan.cycle_number || '-'"/>
                                        <td t-esc="scan.part_name || '-'"/>
                                    </tr>
                                </t>
                                <t t-if="!state.recent_scans || state.recent_scans.length === 0">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No scans yet</td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>
            </t>
        </div>
    </t>
</templates>
